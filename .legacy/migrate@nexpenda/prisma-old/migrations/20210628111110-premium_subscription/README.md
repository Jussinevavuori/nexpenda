# Migration `20210628111110-premium_subscription`

This migration has been generated by Jussi at 6/28/2021, 2:11:10 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "stripe_prices" DROP CONSTRAINT "stripe_prices_product_id_fkey"

ALTER TABLE "subscriptions" DROP CONSTRAINT "subscriptions_uid_fkey"

DROP TYPE "SubscribableProduct"

CREATE TABLE "premium_subscriptions" (
    "id" TEXT NOT NULL,
    "uid" TEXT NOT NULL,
    "current_period_end" TIMESTAMP(3),
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY ("id")
)

DROP TABLE "stripe_prices"

DROP TABLE "stripe_products"

DROP TABLE "subscriptions"

CREATE UNIQUE INDEX "premium_subscriptions.uid_unique" ON "premium_subscriptions"("uid")

ALTER TABLE "premium_subscriptions" ADD FOREIGN KEY("uid")REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20210628110017-remove_unit_amount_decimal..20210628111110-premium_subscription
--- datamodel.dml
+++ datamodel.dml
@@ -3,16 +3,11 @@
 }
 datasource postgresql {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
-// Each user is connected to a user account, which contains their ID, login
-// details and other authentication details. The user account may also specify
-// the user's google account and stripe customer ID. All other user data is
-// linked back to the user object with a UID field. Each user is also connected
-// to a profile.
 model User {
   id               String   @id @default(uuid())
   email            String?  @unique
   emailVerified    Boolean  @default(false) @map("email_verified")
@@ -31,15 +26,13 @@
   Feedback            Feedback[]
   Profile             Profile?
   Log                 Log[]
   TransactionSchedule TransactionSchedule[]
-  Subscription        UserSubscription?
+  Subscription        PremiumSubscription?
   @@map(name: "users")
 }
-// Profile contains public user data such as the user's id, name, photo,
-// optional google photo and settings.
 model Profile {
   uid            String   @id
   displayName    String?  @map("display_name")
   photoUrl       String?  @map("photo_url")
@@ -53,11 +46,8 @@
   @@map(name: "profiles")
 }
-// Transactions contain all incomes and expenses and other details. All
-// transactions belong to a category and a user and may optionally specify
-// that they belong to a specific transaction schedule.
 model Transaction {
   id            String   @id @default(uuid())
   uid           String
   categoryId    String   @map("category_id")
@@ -74,12 +64,8 @@
   @@map(name: "transactions")
 }
-// All transaction schedules specify template data for creating transactions
-// and the intervalType, intervalLength, firstOccurrence and occurrences
-// fields that model when transactions according to the template should be
-// created.
 model TransactionSchedule {
   id                      String       @id @default(uuid())
   uid                     String
   categoryId              String       @map("category_id")
@@ -99,19 +85,15 @@
   @@map(name: "transaction_schedules")
 }
-// Possible interval types for transaction schedules
 enum IntervalType {
   DAY
   WEEK
   MONTH
   YEAR
 }
-// All budgets are used to analyze transactions and measure if their sum
-// exceed the set limit in integerAmount. A budget only measures transactions
-// that belong to categories specified by the budget category inclusiosn field.
 model Budget {
   id            String   @id @default(uuid())
   uid           String
   label         String?
@@ -126,9 +108,8 @@
   @@map(name: "budgets")
 }
-// Intermediate table for manually connecting budgets to categories.
 model BudgetCategoryInclusion {
   budgetId   String @map("budget_id")
   categoryId String @map("category_id")
@@ -137,11 +118,8 @@
   @@id([categoryId, budgetId])
 }
-// Categories contain their name in the value field, an optional icon and
-// metadata. All transactions belong to a category and categories are linked
-// to budgets with budget category inclusions.
 model Category {
   id        String   @id @default(uuid())
   uid       String
   value     String
@@ -159,19 +137,16 @@
   @@unique([uid, id], name: "unique_uid_id")
   @@map(name: "categories")
 }
-// All simple feedback items include the user who left the message and the
-// feedback message itself.
 model Feedback {
   id      String  @id @default(uuid())
   uid     String
   message String?
   User User @relation(fields: [uid], references: [id])
 }
-// Shape of logs that are saved to the database.
 model Log {
   id         String   @id @default(uuid())
   uid        String?
   type       String
@@ -186,66 +161,26 @@
   User User? @relation(fields: [uid], references: [id])
 }
-// All configuration values are string key-value pairs that are further
-// processed on the server.
 model Config {
   key   String @id
   value String
 }
 // Subscriptions
-model UserSubscription {
-  id               String              @id @default(uuid())
-  uid              String              @unique
-  product          SubscribableProduct
-  currentPeriodEnd DateTime?           @map("current_period_end")
-  createdAt        DateTime            @default(now()) @map("created_at")
-  updatedAt        DateTime            @default(now()) @updatedAt @map("updated_at")
+model PremiumSubscription {
+  id               String    @id @default(uuid())
+  uid              String    @unique
+  currentPeriodEnd DateTime? @map("current_period_end")
+  createdAt        DateTime  @default(now()) @map("created_at")
+  updatedAt        DateTime  @default(now()) @updatedAt @map("updated_at")
   User User @relation(fields: [uid], references: [id])
-  @@map(name: "subscriptions")
+  @@map(name: "premium_subscriptions")
 }
-// Possible subscription items
-enum SubscribableProduct {
-  PREMIUM
-}
-
-// Copies of stripe products
-model StripeProduct {
-  id          String   @id
-  active      Boolean
-  description String
-  name        String
-  createdAt   DateTime @default(now()) @map("created_at")
-  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")
-
-  ProductPrice StripePrice[]
-
-  @@map(name: "stripe_products")
-}
-
-// Copies of stripe prices
-model StripePrice {
-  id                String   @id
-  productId         String   @map("product_id")
-  active            Boolean
-  currency          String
-  nickname          String?
-  type              String
-  recurringInterval String?  @map("recurring_interval")
-  createdAt         DateTime @default(now()) @map("created_at")
-  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")
-
-  Product StripeProduct @relation(fields: [productId], references: [id])
-
-  @@map(name: "stripe_prices")
-}
-
-// Copies of stripe prices
 model PremiumPrice {
   id                     String   @id
   unitAmount             Int?     @map("unit_amount")
   productId              String   @map("product_id")
```


